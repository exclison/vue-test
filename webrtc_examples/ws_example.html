<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <video id="video_content" autoplay></video>

    <script src="./js//ws_connection.js"></script>
    <script src="./js//rtc_connection.js"></script>
    <script>
      const openHandler = () => {
        console.log("连接服务器成功");
        const params = JSON.stringify({
          name: "excliosn1",
          type: "ws_register",
        });
        connection.sendMessage(params);
        sendOffer();
        // initRTC();

        // getMedia().then((res) => {
        //   console.log(res, "res");
        //   initRTC();
        // });
      };

      const closeHandler = () => console.log("服务器关闭");

      const errorHandler = () => console.log("连接出错");

      const messageHandler = (e) => {
        let message = JSON.parse(e.data);
        const { sdp: answer } = message;
        // setRemoteDescription(answer);
        rtcconnection.instance.setRemoteDescription(answer);
        console.log(message, "message");
      };

      const connection = new Connection({
        url: "ws://127.0.0.1:8000",
        messageHandler,
        openHandler,
        closeHandler,
        errorHandler,
      });

      const getMedia = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: true,
          video: true,
        });
        const video = document.querySelector("#video_content");
        console.log(stream, "stream");

        video.srcObject = stream;
        console.log(video, "video");
        return stream;
      };

      // 发起端
      const config = {
        iceServers: [
          {
            urls: "stun:stun.l.google.com:19302",
            username: "excliosn1",
            // credential: "webrtcdemo",//尽在tun服务器时使用
          },
        ],
      };

      const onicecandidate = () => {
        console.log(event, "event");
        if (event.candidate) {
          //   sendCandidateToRemotePeer(event.candidate);
        }
      };

      const rtcconnection = new RTCConnection({ options: config, onicecandidate });

      const sendOffer = async () => {
        const offer = await rtcconnection.createOffer();
        await rtcconnection.setLocalDescription(offer);
        const params = JSON.stringify({
          name: "excliosn1",
          type: "video-offer",
          target: "excliosn2",
          sdp: rtcconnection.instance.localDescription,
        });
        console.log(params, "params");
        // ws.send(params);
        connection.sendMessage(params);
      };

      function createChannel() {
        const channel = peerConnection.createDataChannel("chat");
        channel.onopen = function (event) {
          channel.send("hi");
        };
        channel.onmessage = function (event) {
          console.log(event.data);
        };
      }
    </script>
  </body>
</html>
