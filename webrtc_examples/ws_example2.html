<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // 接收端
      const pc = new RTCPeerConnection();

      const ws = new WebSocket("ws://127.0.0.1:8000");
      ws.onopen = function (e) {
        console.log("连接服务器成功");
        // 向服务器发送消息
        const params = JSON.stringify({
          name: "excliosn2",
          type: "video-answer",
          target: "excliosn1",
        });
        console.log(params, "params");
        ws.send(params);
      };
      ws.onclose = function (e) {
        console.log("服务器关闭");
      };
      ws.onerror = function () {
        console.log("连接出错");
      };
      // 接收服务器的消息
      ws.onmessage = function (e) {
        // console.log(e, "e");
        let message = JSON.parse(e.data);
        const { sdp: offer } = message;
        initRTC(offer);
        console.log(message);
      };

      function initRTC(offer) {
        pc.setRemoteDescription(new RTCSessionDescription(offer), function () {
          console.log("session");
          pc.createAnswer()
            .then(function (answer) {
              console.log("anser");
              return pc.setLocalDescription(answer);
            })
            .then(function () {
              console.log("ansert");
              sendAnswer(pc);
              // Send the answer to the remote peer through the signaling server.
            });
        });
      }

      function sendAnswer(pc) {
        const params = JSON.stringify({
          name: "excliosn2",
          type: "video-answer",
          target: "excliosn1",
          sdp: pc.localDescription,
        });

        ws.send(params);
      }
      pc.ondatachannel = function (event) {
        const channel = event.channel;
        channel.onopen = function (event) {
          channel.send("Hi back!");
        };
        channel.onmessage = function (event) {
          console.log(event.data);
        };
      };
      pc.onicecandidate = (event) => {
        console.log(event,'event')
        if (event.candidate) {
        //   sendCandidateToRemotePeer(event.candidate);
        }
      };
    </script>
  </body>
</html>
