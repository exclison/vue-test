<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script>
      // 发起端
      const peerConnection = new RTCPeerConnection();
      peerConnection.onicecandidate = (event) => {
        console.log(event, "event");
        if (event.candidate) {
          //   sendCandidateToRemotePeer(event.candidate);
        }
      };

      const ws = new WebSocket("ws://127.0.0.1:8000");
      ws.onopen = function (e) {
        console.log("连接服务器成功");
        initRTC();

        // 向服务器发送消息
        // ws.send("what`s your name?");
      };
      ws.onclose = function (e) {
        console.log("服务器关闭");
      };
      ws.onerror = function () {
        console.log("连接出错");
      };
      // 接收服务器的消息
      ws.onmessage = function (e) {
        let message = JSON.parse(e.data);
        const { sdp: answer } = message;
        setRemoteDescription(answer);
        console.log(message);
      };

      function initRTC() {
        console.log(333);
        console.log(peerConnection, "kkk");

        peerConnection
          .createOffer()
          .then(function (offer) {
            return peerConnection.setLocalDescription(offer);
          })
          .then(function () {
            const params = JSON.stringify({
              name: "excliosn1",
              type: "video-offer",
              target: "excliosn2",
              sdp: peerConnection.localDescription,
            });
            // console.log(params, "params");
            ws.send(params);
          })
          .catch(function (reason) {
            // An error occurred, so handle the failure to connect
          });
      }

      function setRemoteDescription(answer) {
        peerConnection
          .setRemoteDescription(new RTCSessionDescription(answer))
          .then(function () {
            console.log("remote");
            createChannel();
            // return createMyStream();
          });
      }

      peerConnection.onaddstream = function (obj) {
        console.log(obj, "obj");
      };

      function createChannel() {
        const channel = peerConnection.createDataChannel("chat");
        channel.onopen = function (event) {
          channel.send("hi");
        };
        channel.onmessage = function (event) {
          console.log(event.data);
        };
      }
    </script>
  </body>
</html>
